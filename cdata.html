<!DOCTYPE html>
  <html>
    <head>
      <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
      <script type='text/javascript' src='https://s3.amazonaws.com/mturk-public/externalHIT_v1.js'></script>
      <style>
        .clickarea {
          background-color:#333;
          overflow:visible;
          width:100px;
          height:90px;
          text-align: center;
          padding-top: 10px;
          box-sizing: border-box;
          border: thin solid #333;
        }
        #indicator {
          background:#fff;
          overflow:visible;
          width:100px;
          height:90px;
          text-align: center;
          padding-top: 10px;
          margin: 50px auto;
        }
        #ready {
          position: fixed;
          top: 40%;
          left: 50%;
          transform: translateX(-50%);
          font-size: 20pt;
          color: white;
          font-family: sans-serif;
        }
        #startarea {
          text-align: center;
          position: fixed;
          bottom: 0%;
          left: 50%;
          transform: translateX(-50%);
          margin: auto;
          margin-bottom: 5px;
          padding: 5px;
          background-color:#77f;
          width:100px;
          cursor: pointer;
        }
        #submitButton {
          position: fixed;
          top: 0%;
          left: 50%;
          transform: translateX(-50%);
          margin: auto;
          margin-top: 50px;
          display: none;
        }
        #press, #trial{
          text-align: center;
          font-size: 48px;
        }
      </style>
    </head>





    <body>
      <form name='mturk_form' method='post' id='mturk_form' action='https://workersandbox.mturk.com/mturk/externalSubmit'>
        <input type='hidden' value='' name='assignmentId' id='assignmentId'/>
        <div id='container'>
        </div>
        <div id="submitArea">
          <input type='submit' id='submitButton' value='Submit'/>
        </div>
      </form>
      <img width="14px" height="14px" id='cursor' style='position: fixed; display: none;'  src='graphics\Circle.png' />





      <script language='Javascript'>turkSetAssignmentID();</script>
      <script language='Javascript'>
        class Trial {
          constructor(container, nextHandler){
            this.container = container;
            this.next = nextHandler;
            this.cursor = document.getElementById('cursor');
            this.factor = 10;
          }

          press(key, num, duration, val1, val2){// MAKE THIS CALL DOUBLE AND USE THAT TO RETURN RESULT
            var doPress = function(){
              this.myBody = document.getElementsByTagName("BODY")[0];
              container.innerHTML = "Press the '" + key + "' key quickly to reveal award amounts. Start when you are ready.";
              container.style.textAlign = "center";
              var indicator = document.createElement("DIV");
              indicator.id = "indicator";

              this.val1 = val1;
              this.val2 = val2;
              this.key = key;
              this.duration = duration;
              this.num = num;
              this.presses = 0;
              this.presser = this.pressed.bind(this);
              this.indicator = indicator;
              var _myself = this;
              this.myBody.onkeyup = function(e){
                _myself.pressed(e);
              }
              container.appendChild(indicator);
            }
            this.ret = [];
            showMessage("Double: Press", "red", false, doPress);

          }

          single(val, side, reveal = true){
            var doSingle = function(){
              container.innerHTML = "";
              this.createClickArea(side, val, reveal);
              this.addStart();
              this.runTrial()
            }
            this.ret = [];
            this.started = false;
            showMessage("Single", "blue", false, doSingle);
          }

          double(val1, val2, reveal = false){
            this.ret = [];
            this.started = false;
            var runDouble = function(){
              this.doDouble(val1, val2, reveal);
            }
            showMessage("Double: Blank", "gray", false, runDouble);

          }


          //-----------------------SUPPOSED TO BE PRIVATE-----------------------//
          doDouble(val1, val2, reveal){
            container.innerHTML = "";
            this.createClickArea("left", val1, reveal);
            this.createClickArea("right", val2, reveal);
            this.addStart();
            this.runTrial()
          }

          endPress(){
            this.myBody.onkeyup = undefined;
            this.container.children[0].style.background =
              (this.presses >= this.num) ? "#0a0" : "#a00";

            this.ret.push(this.presses, this.num);
            setTimeout(function(){
              this.doDouble(this.val1, this.val2, this.presses >= this.num)
            }.bind(this), 1500)

          }

          pressed(e){
            if(e.key === this.key){
              this.indicator.style.background = "#888";
              if(this.presses === 0){
                setTimeout(this.endPress.bind(this), this.duration);
              }
              this.presses += 1;
            }
          }

          pix2num(pix){
            return parseFloat(pix.substring(0, pix.length - 2));
          }

          moveCallback(e){
            var cursor = this.cursor;
            var factor = this.factor;

            var movementX = e.movementX ||
                e.mozMovementX          ||
                e.webkitMovementX       ||
                0,
            movementY = e.movementY ||
                e.mozMovementY      ||
                e.webkitMovementY   ||
                0;

            var pix2num = this.pix2num;
            this.mouseRecord(pix2num(cursor.style.left), pix2num(cursor.style.top));

            if(movementX > 0){
              var newleft = pix2num(cursor.style.left) + movementX/factor;
              if(newleft < 1920){
                cursor.style.left = newleft.toString() + "px";
              }
            } else if(movementX < 0){
              var newleft = pix2num(cursor.style.left) + movementX/factor;
              if(newleft > 0){
                cursor.style.left = newleft.toString() + "px";
              }
            }

            if(movementY > 0){
              var newtop = pix2num(cursor.style.top) + movementY/factor;
              if(newtop < 1000){
                cursor.style.top = newtop.toString() + "px";
              }
            } else if(movementY < 0){
              var newtop = pix2num(cursor.style.top) + movementY/factor;
              if(newtop > 0){
                cursor.style.top = newtop.toString() + "px";
              }
            }

            var clickareas = document.getElementsByClassName("clickarea");
            for(var i = 0; i < clickareas.length; i++){
              if(this.lockMouseOn(clickareas[i].getBoundingClientRect())){
                clickareas[i].style.border = "medium solid white";
              } else {
                clickareas[i].style.border = "thin solid " + String(clickareas[i].style.backgroundColor);
              }
            }
          }

          lockMouseOn(bb){
            var cursor = this.cursor;
            var x = this.pix2num(cursor.style.left) + cursor.width/2;
            var y = this.pix2num(cursor.style.top) + cursor.height/2;

            return x >= bb.left && x <= bb.right && y >= bb.top && y <= bb.bottom;
          }

          checkClicks(){
            var clickareas = document.getElementsByClassName("clickarea");
            for(var i = 0; i < clickareas.length; i++){
              if(this.lockMouseOn(clickareas[i].getBoundingClientRect())){
                this.hitDetect.call(this, clickareas[i]);
              }
            }
          }



          changeCallback(e){
            var cursor = this.cursor;
            if (document.pointerLockElement === cursor ||
                  document.mozPointerLockElement === cursor ||
                  document.webkitPointerLockElement === cursor) {
                // Pointer was just locked
                // Enable the mousemove listener

                cursor.style.display = 'inline';

                if(!this.started){
                  console.log('updating doc move');
                  this.mover = this.moveCallback.bind(this);
                  document.onmousemove = this.mover;
                  this.started = true;
                  this.startTrial.call(this);
            }
              } else {
                // Pointer was just unlocked
                // Disable the mousemove listener
                document.onmousemove = undefined;
                cursor.style.display = 'none';

                document.onclick = undefined;
            }
          }

          runTrial(){
            //this.ptimes = [];
            this.mouse = [];
            this.mtimes = [];
            this.choice = 0;
            this.timers = [];
            this.myBody = document.getElementsByTagName("BODY")[0];
            var lock = this.changeCallback.bind(this);
            document.onpointerlockchange = document.onpointerlockchange ||
                  document.onmozpointerlockchange ||
                  document.onwebkitpointerlockchange;

            document.onpointerlockchange = lock;
          }

          startTrial(){
            this.startTime = Date.now();
            this.start.style.cursor = "auto";
            var start = this.start;
            var timers = this.timers;
            var _myself = this;
            start.onclick = undefined;
            start.innerHTML = "5<br />Seconds";
            start.style.background='#27e800';

            document.onclick = this.checkClicks.bind(this);

            timers.push(setTimeout(function(){ start.innerHTML = "4<br />Seconds" }, 1000));
            timers.push(setTimeout(function(){ start.innerHTML = "3<br />Seconds" }, 2000));
            timers.push(setTimeout(function(){ start.innerHTML = "2<br />Seconds" }, 3000));
            timers.push(setTimeout(function(){ start.innerHTML = "1<br />Seconds" }, 4000));
            timers.push(setTimeout(function(){
              _myself.finish();
              document.getElementById("submitButton").style.display="none";
            }, 5000));

          }

          createClickArea(gravity, cash, reveal){
            var div = document.createElement("DIV");
            div.className = "clickarea";
            div.cash = cash;
            div.style.float = gravity;

            if(reveal){
              var rgb = "#0000" + (Math.round(255*cash)).toString(16);
              div.style.background = rgb;
            }
            div.style.borderColor = div.style.backgroundColor;
            this.container.appendChild(div);
          }

          addStart(){
            var start = document.createElement("DIV");
            start.id = "startarea";
            start.innerHTML = "Click here to start.";
            var cursor = this.cursor;
            cursor.requestPointerLock = cursor.requestPointerLock ||
                   cursor.mozRequestPointerLock ||
                   cursor.webkitRequestPointerLock;
            start.onclick = function(e){
              cursor.style.left = String(e.clientX) + 'px';
              cursor.style.top = String(e.clientY) + 'px';
              cursor.requestPointerLock();
            }

            container.appendChild(start);
            this.start = start;

          }

          mouseRecord(x, y){
            var coor = "{" + x + "," + y + "}";
            this.mouse.push(coor);
            this.mtimes.push(Date.now() - this.startTime);
          }

          hitDetect(target) {
            this.choice = target.cash;
            this.finish();
          }

          finish(){
            document.onmousemove = undefined;
            document.exitPointerLock = document.exitPointerLock ||
                 document.mozExitPointerLock ||
                 document.webkitExitPointerLock;
            document.exitPointerLock();
            var clickareas = document.getElementsByClassName("clickarea");
            for(var i = 0; i < clickareas.length; i++){
              clickareas[i].onclick = undefined;
            }

            this.start.innerHTML = "You won:<br />$" + this.choice;

            //document.getElementById("demo").innerHTML = document.getElementById("mturk_form").choicedata;
            for(var i = 0; i <  this.timers.length; i++){
              clearTimeout(this.timers[i]);
            }
            var ret = this.ret;
            ret.push(this.mtimes, this.mouse, this.choice);
            setTimeout(function(){ this.next(ret);  }, 3000) //runs next trial
          }
        }
      </script>
      <script language='Javascript'>
        var trial = new Trial(document.getElementById('container'), next);
        var trials = [];
        var results = [];
        var count = 0;
        var pressResult = true;

        var havePointerLock = 'pointerLockElement' in document ||
            'mozPointerLockElement' in document ||
            'webkitPointerLockElement' in document;

        if(havePointerLock){

          var container = document.getElementById('container');

          function firstTap(){

            document.onpointerlockchange = document.onpointerlockchange ||
                  document.onmozpointerlockchange ||
                  document.onwebkitpointerlockchange;

            document.onpointerlockchange = lockReceived;

            container.requestPointerLock = container.requestPointerLock ||
                   container.mozRequestPointerLock ||
                   container.webkitRequestPointerLock;
            container.requestPointerLock();
          }

          function lockReceived(){
            if(document.pointerLockElement === container ||
                  document.mozPointerLockElement === container ||
                  document.webkitPointerLockElement === container) {

                document.exitPointerLock = document.exitPointerLock ||
                     document.mozExitPointerLock ||
                     document.webkitExitPointerLock;
                document.exitPointerLock();
                startTrial();
            }
          }

          showMessage("Get Ready! Press t and accept the cursor prompt to begin.", "white", true, firstTap);
          pushTrial("press", "f", 11, 2000, 0.82, 0.07);
          pushTrial("double", 0.36, 0.74);
          pushTrial("single", 0.43, "left");
        } else {
          showMessage("Cannot replace the mouse cursor, please try another browser.", 'white', false, function(){});
        }

        function showMessage(message, color, waitPress, callback){
          document.getElementsByTagName("BODY")[0].style.backgroundColor = 'rgb(90, 90, 90)';
          container.innerHTML = '<div id="ready" style="color: ' + color + '"></div>'
          ready = document.getElementById("ready");
          ready.innerText = message;
          if(waitPress){
            document.addEventListener("keypress", function(e){
              if(e.key == "t"){
                document.removeEventListener("keypress", arguments.callee);
                callback.call(trial);
              }

            })
          } else {
              setTimeout(function(){callback.call(trial)}, 2000)
          }
        }

        function pushTrial(){
          trials.push(arguments);
        }

        function startTrial(){
          if(trials.length > 0){
            var info = trials.shift();
            switch(String(info[0])){
              case "double":
                trial.double(info[1], info[2], info.length > 3 ? info[3] : undefined);
                break;
              case "single":
                trial.single(info[1], info[2], info.length > 3 ? info[3] : undefined);
                break;
              case "press":
                trial.press(info[1], info[2], info[3], info[4], info[5]);
                break;
              case "break":
                showMessage("Take a break. Press t to continue.", "white", true, function(){
                  count++;
                  startTrial();
                })
                break;
            }
          } else {
            console.log("Done!");
            /*document.exitPointerLock = document.exitPointerLock ||
                 document.mozExitPointerLock ||
                 document.webkitExitPointerLock;
            document.exitPointerLock();*/
            var container = document.getElementById("container");
            //document.getElementById("submitButton").style.display="inherit";
            container.innerHTML = "";
            for(var i = 0; i < results.length; i++){
              var args = Array.prototype.slice.call(results[i]);
              container.innerHTML += (args + "<br /><br />");
            }
            container.innerHTML += "<br />";
          }
        }

        function next(){
          results[count] = arguments;
          count++;
          startTrial();
        }
      </script>
      <script>
        //document.getElementById("mturk_form").cursordata = response[2];
        //document.getElementById("mturk_form").choicedata = response[3];
      </script>
    </body>
  </html>
